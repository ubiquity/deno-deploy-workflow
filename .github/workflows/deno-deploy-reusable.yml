name: Reusable - Deno Deploy

on:
  workflow_call:
    inputs:
      project:
        description: Optional Deno Deploy project name for production (defaults to derived from repository name)
        required: false
        type: string
        default: ""
      preview_project:
        description: Optional preview project name (defaults to "preview-<project>")
        required: false
        type: string
        default: ""
      entrypoint:
        description: Entrypoint file passed to deployctl (relative to root)
        required: true
        type: string
      root:
        description: Directory to deploy from
        required: false
        type: string
        default: "."
      deno_version:
        description: Deno version range
        required: false
        type: string
        default: v2.x
      deployctl_version:
        description: deployctl version to install
        required: false
        type: string
        default: "1.12.0"
      install_command:
        description: Optional install command (multi-line allowed)
        required: false
        type: string
        default: ""
      build_command:
        description: Optional build command (multi-line allowed)
        required: false
        type: string
        default: ""
      node_version:
        description: Set to install Node.js (empty to skip)
        required: false
        type: string
        default: ""
      bun_version:
        description: Set to install Bun (empty to skip)
        required: false
        type: string
        default: ""
      include:
        description: Newline-separated include globs for deployctl
        required: false
        type: string
        default: ""
      exclude:
        description: Newline-separated exclude globs for deployctl
        required: false
        type: string
        default: |
          .git
          .github
          node_modules
          dist
          build
          coverage
          .turbo
          .next
          .vercel
      env_var_keys:
        description: Newline-separated env var names to forward as --env-var
        required: false
        type: string
        default: ""
      runtime_env:
        description: Newline-separated KEY=VALUE lines to forward as --env-var (preferred)
        required: false
        type: string
        default: ""
      build_env:
        description: Newline-separated KEY=VALUE lines to export before install/build
        required: false
        type: string
        default: ""
      ensure_project:
        description: Ensure the target project exists via Deno Deploy API before deploying
        required: false
        type: boolean
        default: true
      project_secrets:
        description: Newline-separated SECRET_NAME=ENV_VAR mappings to persist as Deno Deploy secrets (production and fallback)
        required: false
        type: string
        default: ""
      preview_project_secrets:
        description: Optional SECRET_NAME=ENV_VAR mappings for preview deployments (overrides project_secrets)
        required: false
        type: string
        default: ""
      required_env:
        description: Newline-separated env vars that must be present to deploy
        required: false
        type: string
        default: |
          DENO_DEPLOY_TOKEN
      submodules:
        description: Submodules checkout mode (empty to skip, 'recursive' for recursive)
        required: false
        type: string
        default: ""
      verify_url:
        description: Probe the deployed URL after deploy
        required: false
        type: boolean
        default: true
      create_preview:
        description: Create preview project when missing
        required: false
        type: boolean
        default: true
      prod_branch:
        description: Branch name for production deployments
        required: false
        type: string
        default: ""
    secrets:
      DENO_DEPLOY_TOKEN:
        required: true
      DENO_PROJECT_SECRETS:
        required: false
      DENO_PREVIEW_PROJECT_SECRETS:
        required: false

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deno Deploy
    runs-on: ubuntu-22.04
    concurrency:
      group: deno-deploy-${{ inputs.project }}-${{ github.ref }}
      cancel-in-progress: true
    env:
      PROD_BRANCH: ${{ inputs.prod_branch != '' && inputs.prod_branch || github.event.repository.default_branch }}
      PROJECT: ${{ inputs.project }}
      PREVIEW_PROJECT: ${{ inputs.preview_project }}
      ENTRYPOINT: ${{ inputs.entrypoint }}
      ROOT_DIR: ${{ inputs.root }}
      INCLUDE: ${{ inputs.include }}
      EXCLUDE: ${{ inputs.exclude }}
      RUNTIME_ENV_KEYS: ${{ inputs.env_var_keys }}
      RUNTIME_ENV: ${{ inputs.runtime_env }}
      BUILD_ENV: ${{ inputs.build_env }}
      ENSURE_PROJECT: ${{ inputs.ensure_project }}
      PROJECT_SECRETS: ${{ inputs.project_secrets != '' && inputs.project_secrets || secrets.DENO_PROJECT_SECRETS || '' }}
      PREVIEW_PROJECT_SECRETS: ${{ inputs.preview_project_secrets != '' && inputs.preview_project_secrets || secrets.DENO_PREVIEW_PROJECT_SECRETS || '' }}
      REQUIRED_ENV: ${{ inputs.required_env }}
      BUILD_COMMAND: ${{ inputs.build_command }}
      INSTALL_COMMAND: ${{ inputs.install_command }}
      CREATE_PREVIEW: ${{ inputs.create_preview }}
      VERIFY_URL: ${{ inputs.verify_url }}
      DENO_VERSION: ${{ inputs.deno_version }}
      DEPLOYCTL_VERSION: ${{ inputs.deployctl_version }}
      NODE_VERSION: ${{ inputs.node_version }}
      BUN_VERSION: ${{ inputs.bun_version }}
      DENO_DEPLOY_TOKEN: ${{ secrets.DENO_DEPLOY_TOKEN }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          submodules: ${{ inputs.submodules }}

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Set up Node.js (optional)
        if: env.NODE_VERSION != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install Bun (optional)
        if: env.BUN_VERSION != ''
        run: |
          set -euo pipefail
          # Use the official install script to avoid setup-bun cache/download flakes.
          BUN_VERSION="${BUN_VERSION}" curl -fsSL https://bun.sh/install | bash
          echo "${HOME}/.bun/bin" >> "$GITHUB_PATH"

      - name: Install deployctl
        run: |
          set -euo pipefail
          deno install -gArf jsr:@deno/deployctl@${{ env.DEPLOYCTL_VERSION }}
          echo "${HOME}/.deno/bin" >> "$GITHUB_PATH"

      - name: Preflight (token and required env)
        id: preflight
        run: |
          set -euo pipefail
          missing=()
          while IFS= read -r key; do
            key=$(echo "$key" | tr -d '\r' | xargs)
            [ -z "$key" ] && continue
            if [ -z "${!key:-}" ]; then
              missing+=("$key")
            fi
          done <<< "$REQUIRED_ENV"

          if [ ${#missing[@]} -gt 0 ]; then
            echo "deploy=no" >> "$GITHUB_OUTPUT"
            {
              echo "### Deno Deploy"
              echo ""
              echo "- Skipped: missing env vars -> ${missing[*]}"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "deploy=yes" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine target project
        if: steps.preflight.outputs.deploy == 'yes'
        id: target
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          project="$PROJECT"
          preview="$PREVIEW_PROJECT"
          if [ -z "$preview" ]; then
            preview="${project}-preview"
          fi
          if [ ${#project} -gt 26 ]; then
            echo "::error::Base project name '${project}' exceeds 26 characters (Deno Deploy's max project name character limit)"
            exit 1
          fi
          if [ ${#preview} -gt 26 ]; then
            echo "::error::Preview project name '${preview}' exceeds 26 characters (Deno Deploy's max project name character limit)"
            exit 1
          fi

          mode="preview"
          target="$preview"
          if [ "$REF_NAME" = "$PROD_BRANCH" ]; then
            mode="production"
            target="$project"
          fi

          echo "mode=$mode" >> "$GITHUB_OUTPUT"
          echo "project=$target" >> "$GITHUB_OUTPUT"

      - name: Export build env
        if: steps.preflight.outputs.deploy == 'yes' && env.BUILD_ENV != ''
        run: |
          set -euo pipefail
          echo "$BUILD_ENV" >> "$GITHUB_ENV"

      - name: Install dependencies
        if: steps.preflight.outputs.deploy == 'yes' && env.INSTALL_COMMAND != ''
        run: |
          set -euo pipefail
          printf '%s\n' "$INSTALL_COMMAND" | bash

      - name: Build
        if: steps.preflight.outputs.deploy == 'yes' && env.BUILD_COMMAND != ''
        run: |
          set -euo pipefail
          printf '%s\n' "$BUILD_COMMAND" | bash

      - name: Ensure project exists and sync secrets
        if: steps.preflight.outputs.deploy == 'yes'
        env:
          MODE: ${{ steps.target.outputs.mode }}
          TARGET_PROJECT: ${{ steps.target.outputs.project }}
        run: |
          set -euo pipefail
          project="$TARGET_PROJECT"
          mode="$MODE"
          if [ -z "$project" ]; then
            echo "::error::Target project was not resolved"
            exit 1
          fi

          secrets_block="$PROJECT_SECRETS"
          if [ "$mode" = "preview" ] && [ -n "$PREVIEW_PROJECT_SECRETS" ]; then
            secrets_block="$PREVIEW_PROJECT_SECRETS"
          fi

          if [ "$ENSURE_PROJECT" != "true" ] && [ -z "$secrets_block" ]; then
            echo "Skipping project ensure/secret sync (disabled and no secrets provided)"
            exit 0
          fi

          api_base="https://dash.deno.com/api/projects"
          tmp_resp="$(mktemp)"
          http_code=$(curl -sS -o "$tmp_resp" -w "%{http_code}" \
            -H "Authorization: Bearer $DENO_DEPLOY_TOKEN" \
            "$api_base/$project" || echo "000")

          if [ "$http_code" = "404" ]; then
            if [ "$ENSURE_PROJECT" != "true" ]; then
              echo "::error::Project $project not found and ensure_project is false"
              cat "$tmp_resp" || true
              exit 1
            fi
            http_code=$(curl -sS -o "$tmp_resp" -w "%{http_code}" \
              -X POST "$api_base" \
              -H "Authorization: Bearer $DENO_DEPLOY_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"$project\"}" || echo "000")
            if [ "$http_code" -ge 300 ] || [ "$http_code" -lt 200 ]; then
              echo "::error::Failed to create project $project (HTTP $http_code)"
              cat "$tmp_resp" || true
              exit 1
            fi
            echo "Created project $project"
          elif [ "$http_code" != "200" ]; then
            echo "::error::Failed to fetch project $project (HTTP $http_code)"
            cat "$tmp_resp" || true
            exit 1
          fi
          rm -f "$tmp_resp"

          if [ -n "$secrets_block" ]; then
            while IFS= read -r line; do
              line=$(echo "$line" | tr -d '\r' | xargs)
              [ -z "$line" ] && continue
              if ! printf '%s\n' "$line" | grep -q '='; then
                echo "::warning::project_secrets line missing '=': $line"
                continue
              fi
              secret_name=${line%%=*}
              env_key=${line#*=}
              if [ -z "$secret_name" ] || [ -z "$env_key" ]; then
                echo "::warning::project_secrets line invalid: $line"
                continue
              fi
              val="${!env_key:-}"
              if [ -z "$val" ]; then
                echo "::warning::Secret $secret_name skipped because env $env_key is empty"
                continue
              fi
              echo "::add-mask::$val"
              tmp_secret="$(mktemp)"
              code=$(curl -sS -o "$tmp_secret" -w "%{http_code}" \
                -X POST "$api_base/$project/secrets" \
                -H "Authorization: Bearer $DENO_DEPLOY_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"name\":\"$secret_name\",\"value\":\"$val\"}" || echo "000")
              if [ "$code" != "200" ]; then
                echo "::error::Failed to set secret $secret_name (HTTP $code)"
                cat "$tmp_secret" || true
                rm -f "$tmp_secret"
                exit 1
              fi
              rm -f "$tmp_secret"
            done <<< "$secrets_block"
          fi

      - name: Deploy to Deno Deploy
        if: steps.preflight.outputs.deploy == 'yes'
        id: deploy
        run: |
          set -euo pipefail
          mode='${{ steps.target.outputs.mode }}'
          target='${{ steps.target.outputs.project }}'

          flags=(
            "--project=$target"
            "--entrypoint=$ENTRYPOINT"
            "--root=$ROOT_DIR"
            "--token=$DENO_DEPLOY_TOKEN"
          )

          if [ "$mode" = "production" ]; then
            flags+=("--prod")
          elif [ "$CREATE_PREVIEW" = "true" ]; then
            flags+=("--create")
          fi

          # Always include entrypoint and deno.json so deployctl finds the server.
          flags+=("--include=$ENTRYPOINT")
          if [ -f "deno.json" ]; then
            flags+=("--include=deno.json")
          fi

          while IFS= read -r inc; do
            inc=$(echo "$inc" | tr -d '\r' | xargs)
            [ -z "$inc" ] && continue
            flags+=("--include=$inc")
          done <<< "$INCLUDE"

          while IFS= read -r exc; do
            exc=$(echo "$exc" | tr -d '\r' | xargs)
            [ -z "$exc" ] && continue
            flags+=("--exclude=$exc")
          done <<< "$EXCLUDE"

          while IFS= read -r key; do
            key=$(echo "$key" | tr -d '\r' | xargs)
            [ -z "$key" ] && continue
            val="${!key:-}"
            if [ -n "$val" ]; then
              flags+=("--env-var=${key}=${val}")
            else
              echo "::warning::Requested env $key for deploy but it is empty"
            fi
          done <<< "$RUNTIME_ENV_KEYS"

          while IFS= read -r line; do
            line=$(echo "$line" | tr -d '\r')
            [ -z "$line" ] && continue
            if ! printf '%s\n' "$line" | grep -q '='; then
              echo "::warning::runtime_env line missing '=': $line"
              continue
            fi
            flags+=("--env-var=$line")
          done <<< "$RUNTIME_ENV"

          deployctl deploy "${flags[@]}"

          echo "project=$target" >> "$GITHUB_OUTPUT"
          echo "mode=$mode" >> "$GITHUB_OUTPUT"

      - name: Determine deployed URL
        if: steps.preflight.outputs.deploy == 'yes' && env.VERIFY_URL == 'true'
        id: deployed_url
        run: |
          set -euo pipefail
          project="${{ steps.deploy.outputs.project }}"
          fallback="https://${project}.deno.dev"
          resp=$(curl -sS -H "Authorization: Bearer $DENO_DEPLOY_TOKEN" "https://dash.deno.com/api/projects/${project}" || true)
          URL=$(PROJECT="$project" FALLBACK="$fallback" RESP="$resp" cat <<'PY' | sed 's/^  //' | python -
            import json, os, sys

            resp = os.environ.get("RESP", "")
            fallback = os.environ.get("FALLBACK", "")
            url = fallback
            try:
                data = json.loads(resp or "{}")
                domains = data.get("domains") or []
                if isinstance(domains, list) and domains:
                    dom = domains[0]
                    if isinstance(dom, dict):
                        dom = dom.get("domain") or dom.get("name") or ""
                    if dom:
                        url = f"https://{dom}"
            except Exception as exc:  # noqa: BLE001
                sys.stderr.write(f"Warning: failed to parse project domains: {exc}\n")
            print(url, end="")
          PY
          )
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Verify deployment
        if: steps.preflight.outputs.deploy == 'yes' && env.VERIFY_URL == 'true'
        id: verify
        run: |
          set -euo pipefail
          url='${{ steps.deployed_url.outputs.url }}'
          codes_ok="200 301 302 308"
          status="warn"
          http_code="000"
          for i in 1 2 3; do
            http_code=$(curl -sS -o /dev/null -w "%{http_code}" "$url" || echo "000")
            if echo "$codes_ok" | grep -q "\b$http_code\b"; then
              status="ok"
              break
            fi
            sleep 5
          done
          echo "http_code=$http_code" >> "$GITHUB_OUTPUT"
          echo "status=$status" >> "$GITHUB_OUTPUT"
          if [ "$status" != "ok" ]; then
            echo "::warning::Deployment probe returned HTTP $http_code"
          fi

      - name: Summary
        if: steps.preflight.outputs.deploy == 'yes'
        run: |
          mode='${{ steps.deploy.outputs.mode }}'
          project='${{ steps.deploy.outputs.project }}'
          url="${{ steps.deployed_url.outputs.url || '' }}"
          http="${{ steps.verify.outputs.http_code || '' }}"
          status="${{ steps.verify.outputs.status || '' }}"
          {
            echo "### Deno Deploy"
            echo ""
            echo "- Mode: ${mode:-unknown}"
            echo "- Project: ${project}"
            if [ -n "$url" ]; then
              echo "- URL: ${url}"
            fi
            if [ -n "$http" ]; then
              echo "- HTTP: ${http} (${status})"
            fi
            echo "- Ref: ${GITHUB_REF##*/}"
          } >> "$GITHUB_STEP_SUMMARY"
